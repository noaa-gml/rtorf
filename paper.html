<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Summary • rtorf</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png"><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Summary"><meta property="og:image" content="https://noaa-gml.github.io/rtorf/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-dark" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">rtorf</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/aircore.html">aircore</a></li>
    <li><a class="dropdown-item" href="articles/aircraft-flask.html">aircraft-flask</a></li>
    <li><a class="dropdown-item" href="articles/aircraft-insitu.html">aircraft-insitu</a></li>
    <li><a class="dropdown-item" href="articles/aircraft-pfp.html">aircraft-pfp</a></li>
    <li><a class="dropdown-item" href="articles/hysplit.html">hysplit</a></li>
    <li><a class="dropdown-item" href="articles/shipboard-flask.html">shipboard-flask</a></li>
    <li><a class="dropdown-item" href="articles/shipoboard-insitu.html">shipboard-insitu</a></li>
    <li><a class="dropdown-item" href="articles/summary.html">summary</a></li>
    <li><a class="dropdown-item" href="articles/surface-flask.html">surface-flask</a></li>
    <li><a class="dropdown-item" href="articles/surface-insitu.html">surface-insitu</a></li>
    <li><a class="dropdown-item" href="articles/surface-pfp.html">surface-pfp</a></li>
    <li><a class="dropdown-item" href="articles/tower-insitu.html">tower-insitu</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/noaa-gml/rtorf/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="logo.png" class="logo" alt=""><h1>Summary</h1>
      <small class="dont-index">Source: <a href="https://github.com/noaa-gml/rtorf/blob/main/paper.md" class="external-link"><code>paper.md</code></a></small>
    </div>


<div id="summary" class="section level1">

<p>In this study, we present a new open-source R package <code>rtorf</code>, to read, process, select, and plot NOAA Observation Package (ObsPack) data products. We use a methane ObsPack data product as an example in this code base, but it can be easily modified to analyze ObsPack products for other greenhouse gasses. The R package starts with creating a catalog of all ObsPack files in each product. It then reads all files and creates one database. While reading each ObsPack file, it extracts site elevation and time zone information from the file header and calculates sampling altitude in meters above ground level and local time for individual samping events. Finally, it processes and selects observations for inverse modeling purposes. This package imports functions from data.table R package, which contains C bindings with parallel implementation via Open-MP [@dt]. rtorf provides functions to perform these tasks in a transparent and efficient way, supporting open-source communities in environmental sciences.</p>
<p>The world is experiencing an accelerated global warming due to the accumulation of greenhouse gases (GHG) since the industrial revolution [@us2018]. Greenhouse gas observations are critical to monitor the state of the atmosphere, quantify present and historical emissions, and understand global climate change. During the 21th Conference of Parties (COP21), it was established the Paris Accord, a multilateral effort reduce greenhouse emissions in order to limit the temperature increment of 1.5 degrees [@rhodes20162015]. Methane is a greenhouse gas responsible for half of the temperature increase since preindustrial levels. Furthermore, methane has a 9 years lifetime and a global warming potential of 30 over 100 years [@epagwp], with a current global radiative forcing of 0.650 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><msup><mi>m</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup></mrow><annotation encoding="application/x-tex">Wm^{-2}</annotation></semantics></math> [@aggi]. Hence, in the 26 version of COP conference [@hunter2021glasgow], it was signed the Global Methane Pledge aiming reduce at least methane emissions 30% from 2020 levels by 2030, with U.S. as one of the parties [@wh]. Therefore, monitoring <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><msub><mi>H</mi><mn>4</mn></msub></mrow><annotation encoding="application/x-tex">CH_4</annotation></semantics></math> observations, emissions and sinks has become critical. NOAA ObsPack data has been used to support many studies. For instance, the global methane budget for the year 2017 was 596 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>g</mi><msup><mi>y</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">Tgy^{-1}</annotation></semantics></math>, in agreement with other studies [@saunois2020global;@saunois2016global] @lu2021global, characterized global methane emissions in between 2014 and 2017, including a comparison with Greenhouse gases Observing SATellite (GOSAT) data. @saunois2016global. At regional scale, @lu2022methane performed another studied focused on north america using as priors local emissions inventories.</p>
<!-- 2. Importance of greenhouse gases observations -->
<!-- 3. NOAA - mandate by congress - Obspack -->
<p>The National Oceanic and Atmospheric Administration (NOAA) and its Global Monitoring Laboratory (GML) has the mission of acquire, evaluate and make available long-term records of atmospheric gases<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;&lt;a href="https://docs.r-wasm.org/webr/latest/" class="external-link uri"&gt;https://docs.r-wasm.org/webr/latest/&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a>. To achieve that goal, GML gather own and other laboratories data, releasing observation in a compendium named ObsPack [@masarie2014obspack]. Specifically, the <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><msub><mi>H</mi><mn>4</mn></msub></mrow><annotation encoding="application/x-tex">CH_4</annotation></semantics></math> ObsPack GLOBALVIEW+ is a comprehensive product consisting in observations from aircrafts, ships, surface stations, towers and aircores. ObsPack include a descriptor named <code>datasetid</code> covering: aircraft-pfp, aircraft-insitu, aircraft-flask, surface-insitu, surface-flask, surface-pfp, tower-insitu, aircore, shipboard-insitu, and shipboard-flask. ObsPack product generally contains hundreds of files, each of which has different sampling frequencies, hours, and attributes. It takes time and effort to develop tools to read and process each ObsPack product and select observations of interest for specific modeling and data analysis purposes.</p>
<p>The NOAA ObsPack data is delivered to the public as NetCDF and text files [@masarie2014obspack]. The structure of the files including descriptor fields depend on the type of file. For instance, the metadata from aircrafts is different than surface stations, but all the files include concentrations and other critical fields. Given the complexity of ObsPack format, reading and analyzing the data can be cumbersome. The <code>rtorf</code> package provides the GHG science and research community a transparent and efficient tool to process ObsPack products for GHG modeling and analyses. In this manuscript we present <code>rtorf</code>, an R package to read, process and plot NOAA ObsPack data, a software useful and needed for the community [@R]. For this release, we are focused on the <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><msub><mi>H</mi><mn>4</mn></msub></mrow><annotation encoding="application/x-tex">CH_4</annotation></semantics></math> ObsPack GLOBALVIEW+ product. The general process consists in creating a summary of the ObsPack files, reading them in an iteration process, filtering, and generating another output and plots.</p>
</div>
<div class="section level1">
<h1 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a></h1>
<p>To install <code>rtorf</code>, the user must have installed the R package remotes and run the following script. This process will install all the required dependencies, such as data.table, <code>cptcity</code>, an R package with more than 7000 color palettes, and <code>lubridate</code>, a package to manage time and dates [@lu;@cpt]. Then, we call the libraries to load the function into the environment. <code>rtorf</code> is hosted at GitHub, which allows the implementation of checking the package installation in a variety OS.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"noaa-gml/rtorf"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/noaa-gml/rtorf" class="external-link">rtorf</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level1">
<h1 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a></h1>
<p><code>rtorf</code> is a collection of function organized together to read and process ObsPack files. The general process consists in create a summary of the ObsPack files, reading them in an iteration process, filter and generating another output. As <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><msub><mi>H</mi><mn>4</mn></msub></mrow><annotation encoding="application/x-tex">CH_4</annotation></semantics></math> ObsPACKGLOBALViewplus 5.1, the product used in this manuscript, includes dataid, we produced a guide for each of of them available at <a href="https://noaa-gml.github.io/rtorf" class="uri">https://noaa-gml.github.io/rtorf</a>. Then, in this manuscript we present the processing of <code>aircraft-insitu</code>. The obspack product in this case is <code>obspack_ch4_1_GLOBALVIEWplus_v5.1_2023-03-08</code>.</p>
<div class="section level2">
<h2 id="summary-1">Summary<a class="anchor" aria-label="anchor" href="#summary-1"></a></h2>
<p>We first call the libraries <code>rtorf</code> and <code>data.table</code>. Most of objects returned by <code>rtorf</code> are of class <code>data.table</code>. Then, we define the datasetid to be identified in the name of the files inside the directory with data. This process print a summary of the data and if the logical argument verbose is <code>TRUE</code>, print the file being read in each iteration, default is <code>FALSE</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/noaa-gml/rtorf" class="external-link">rtorf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="va">cate</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"aircraft-pfp"</span>,</span>
<span>         <span class="st">"aircraft-insitu"</span>,</span>
<span>         <span class="st">"aircraft-flask"</span>,</span>
<span>         <span class="st">"surface-insitu"</span>,</span>
<span>         <span class="st">"surface-flask"</span>, </span>
<span>         <span class="st">"surface-pfp"</span>,   </span>
<span>         <span class="st">"tower-insitu"</span>,  </span>
<span>         <span class="st">"aircore"</span>,       </span>
<span>         <span class="st">"shipboard-insitu"</span>,</span>
<span>         <span class="st">"shipboard-flask"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="st">"Z:/torf/obspack_ch4_1_GLOBALVIEWplus_v5.1_2023-03-08/data/nc/"</span></span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_summary.html">obs_summary</a></span><span class="op">(</span>obs <span class="op">=</span> <span class="va">obs</span>, </span>
<span>                     categories <span class="op">=</span> <span class="va">cate</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Number of files of index: 429</span></span>
<span><span class="co">##               sector     N</span></span>
<span><span class="co">##               &lt;char&gt; &lt;int&gt;</span></span>
<span><span class="co">##  1:     aircraft-pfp    40</span></span>
<span><span class="co">##  2:  aircraft-insitu    15</span></span>
<span><span class="co">##  3:    surface-flask   106</span></span>
<span><span class="co">##  4:   surface-insitu   174</span></span>
<span><span class="co">##  5:   aircraft-flask     4</span></span>
<span><span class="co">##  6:          aircore     1</span></span>
<span><span class="co">##  7:      surface-pfp    33</span></span>
<span><span class="co">##  8:     tower-insitu    51</span></span>
<span><span class="co">##  9:  shipboard-flask     4</span></span>
<span><span class="co">## 10: shipboard-insitu     1</span></span>
<span><span class="co">## 11:    Total sectors   429</span></span>
<span><span class="co">## Detected 190 files with agl</span></span>
<span><span class="co">## Detected 239 files without agl</span></span></code></pre>
<p>Once the index of file is built, we can read each file. As we are directing to the nc directory in ObsPack, with NetCDF files inside, we use the function <code>obs_read_nc</code>. This function dumps the NetCDF information into a data.table with <code>long</code> format [@Silge2016]. As the global attributes is attributes in the NetCDF would result in a data.table with too many columns, we used the argument <code>att</code> equals to FALSE, which is default. In ground-based datasetid the <code>solar_time</code> array is available. This is useful to select specific observations, for more information check the site documentation. At the moment, this array is not available for aircraft observations, hence we select <code>FALSE</code>. In this case, we select <code>verbose</code> equal to <code>TRUE</code>, to see the name of the files being read.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">datasetid</span> <span class="op">&lt;-</span> <span class="st">"aircraft-insitu"</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_read_nc.html">obs_read_nc</a></span><span class="op">(</span>index <span class="op">=</span> <span class="va">index</span>,</span>
<span>                  categories <span class="op">=</span> <span class="va">datasetid</span>,</span>
<span>                  att <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  solar_time <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Searching aircraft-insitu...</span></span>
<span><span class="co">## 1: ch4_above_aircraft-insitu_1_allvalid.nc</span></span>
<span><span class="co">## 2: ch4_act_aircraft-insitu_428_allvalid-b200.nc</span></span>
<span><span class="co">## 3: ch4_act_aircraft-insitu_428_allvalid-c130.nc</span></span>
<span><span class="co">## 4: ch4_cob2003b_aircraft-insitu_59_allvalid.nc</span></span>
<span><span class="co">## 5: ch4_eco_aircraft-insitu_1_allvalid.nc</span></span>
<span><span class="co">## 6: ch4_hip_aircraft-insitu_59_allvalid.nc</span></span>
<span><span class="co">## 7: ch4_iagos-caribic_aircraft-insitu_457_allvalid.nc</span></span>
<span><span class="co">## 8: ch4_korus-aq_aircraft-insitu_428_allvalid-dc8.nc</span></span>
<span><span class="co">## 9: ch4_man_aircraft-insitu_1_allvalid.nc</span></span>
<span><span class="co">## 10: ch4_orc_aircraft-insitu_3_allvalid-merge10.nc</span></span>
<span><span class="co">## 11: ch4_seac4rs_aircraft-insitu_428_allvalid-ER2.nc</span></span>
<span><span class="co">## 12: ch4_seac4rs_aircraft-insitu_428_allvalid-dc8.nc</span></span>
<span><span class="co">## 13: ch4_start08_aircraft-insitu_59_allvalid.nc</span></span>
<span><span class="co">## 14: ch4_tom_aircraft-insitu_1_allvalid.nc</span></span>
<span><span class="co">## 15: ch4_ugd_aircraft-insitu_1_allvalid.nc</span></span></code></pre>
<p>The resulting <code>data.table</code> contains 59 columns and 2041758 observations. Furthermore, the size of <code>data.table</code> is 1.4 Gb. The data includes observations between 2003 and 2021. Now we can define some parameters to filter our data, like the year 2020 and spatially data below 8000 meters above sea level (masl) and focused over north America.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2020</span> <span class="op">&amp;</span></span>
<span>           <span class="va">altitude_final</span> <span class="op">&lt;</span> <span class="fl">8000</span> <span class="op">&amp;</span></span>
<span>           <span class="va">latitude</span> <span class="op">&lt;</span> <span class="fl">80</span> <span class="op">&amp;</span></span>
<span>           <span class="va">latitude</span> <span class="op">&gt;</span> <span class="fl">10</span> <span class="op">&amp;</span></span>
<span>           <span class="va">longitude</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">50</span> <span class="op">&amp;</span></span>
<span>           <span class="va">longitude</span> <span class="op">&gt;</span> <span class="op">-</span><span class="fl">170</span><span class="op">]</span></span></code></pre></div>
<p>Now we have a <code>data.table</code> that contains 59 columns and 236 observations. The size of <code>data.table</code> is 0 Gb. We can add a column of time in format “POSIXct” and cut the seconds every 20 seconds. Usually, aircraft observations every 1 second. Then, We can simplify the data by calculating averages every 20 seconds. We perform this task by cutting time very 20 seconds. Then, we add a new column with the mandatory name <code>key_time</code>, which will be used to aggregate data with “POSIXct” class, but every 20 seconds.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_addtime.html">obs_addtime</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Adding timeUTC</span></span>
<span><span class="co">## Adding timeUTC_start</span></span>
<span><span class="co">## Adding timeUTC_end</span></span>
<span><span class="co">## Found time_interval</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span><span class="op">$</span><span class="va">sec2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_freq.html">obs_freq</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">second</span>,</span>
<span>                    freq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">59</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">key_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ISOdatetime.html" class="external-link">ISOdatetime</a></span><span class="op">(</span>year <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">year</span>,</span>
<span>                           month <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">month</span>,</span>
<span>                           day <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">day</span>,</span>
<span>                           hour <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">hour</span>,</span>
<span>                           min <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">minute</span>,</span>
<span>                           sec <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">sec2</span>,</span>
<span>                           tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">[</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"timeUTC"</span>, <span class="st">"key_time"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##                timeUTC            key_time</span></span>
<span><span class="co">##                 &lt;POSc&gt;              &lt;POSc&gt;</span></span>
<span><span class="co">## 1: 2020-01-08 22:59:55 2020-01-08 22:59:40</span></span></code></pre>
<p>now we can aggregate the data using the function <code>obs_agg</code>. The argument cols indicate which columns will be averaged. Then, we add local time with the function <code>obs_addltime</code> and we re order the data.table.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_agg.html">obs_agg</a></span><span class="op">(</span><span class="va">df</span>, </span>
<span>               cols <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"month"</span>, <span class="st">"day"</span>, <span class="st">"hour"</span>, <span class="st">"minute"</span>, <span class="st">"second"</span>,</span>
<span>                         <span class="st">"time"</span>, <span class="st">"time_decimal"</span>,  <span class="st">"value"</span>,</span>
<span>                         <span class="st">"latitude"</span>, <span class="st">"longitude"</span>, <span class="st">"altitude_final"</span>,</span>
<span>                         <span class="st">"pressure"</span>, <span class="st">"u"</span>, <span class="st">"v"</span>, <span class="st">"temperature"</span>, <span class="st">"type_altitude"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Adding time</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df3</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_addltime.html">obs_addltime</a></span><span class="op">(</span><span class="va">df2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorderv</a></span><span class="op">(</span><span class="va">df3</span>, cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"site_code"</span>, <span class="st">"timeUTC"</span><span class="op">)</span>,</span>
<span>          order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="solar-or-local-time">Solar or local time<a class="anchor" aria-label="anchor" href="#solar-or-local-time"></a></h2>
<p>Identifying the local time is important for atmospheric reasons. Sometimes we need observations when the Planetary Boundary Layer is high, so that the concentrations are well distributed, generaly around 2:00pm. In <code>rtorf</code> we use an hierarchical approach based on the availability of critical information. Basically, if the solar time array is available, we use the functon <code>obs_addstime</code>. In the begative case <code>rtorf</code> searches for the metadata <code>site_utc2lst</code> ot convert UTC time to local. Finally, in the absence of the mentioned data, we calculate an approximation of the local time using the geographical coordinates, as :</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>t</mi><mo>=</mo><mi>U</mi><mi>T</mi><mi>C</mi><mo>+</mo><mi>l</mi><mi>o</mi><mi>n</mi><mi>g</mi><mi>i</mi><mi>t</mi><mi>u</mi><mi>d</mi><mi>e</mi><mi>/</mi><mn>15</mn><mo>*</mo><mn>60</mn><mo>*</mo><mn>60</mn></mrow><annotation encoding="application/x-tex">
lt = UTC + longitude/15 * 60 * 60
</annotation></semantics></math> Where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">lt</annotation></semantics></math> is the local time, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mi>T</mi><mi>C</mi></mrow><annotation encoding="application/x-tex">UTC</annotation></semantics></math> the time, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>n</mi><mi>g</mi><mi>i</mi><mi>t</mi><mi>u</mi><mi>d</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">longitude</annotation></semantics></math> the coordinate.</p>
</div>
<div class="section level2">
<h2 id="plots">Plots<a class="anchor" aria-label="anchor" href="#plots"></a></h2>
<p>Now we have the data processed and ready to be exported. <code>rtorf</code> includes a number of functions to save the data as takbulated format in text, csv and CSVY<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;&lt;a href="https://csvy.org/" class="external-link uri"&gt;https://csvy.org/&lt;/a&gt;&lt;/p&gt;'><sup>2</sup></a> are csv files with a YAML header. This funcitons can be seen in the documentation. In this last part of the manuscript we will show some visualizations. We included a function named <code>obs_plot</code> which plots data in long format using R base functions. Here we see data for the month of March 2020. This usefull function allows to plot several sites and prints the x-axis range.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/obs_plot.html">obs_plot</a></span><span class="op">(</span><span class="va">df3</span><span class="op">[</span><span class="va">month</span> <span class="op">==</span> <span class="fl">3</span><span class="op">]</span>, time <span class="op">=</span> <span class="st">"timeUTC"</span>, yfactor <span class="op">=</span> <span class="fl">1e9</span>, type <span class="op">=</span> <span class="st">"b"</span>,</span>
<span>         xlab <span class="op">=</span> <span class="st">"UTC time"</span>, ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">CH</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">~</span><span class="va">ppb</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Found the following sites:</span></span>
<span><span class="co">## [1] IAGOS</span></span>
<span><span class="co">## Plotting the following sites:</span></span>
<span><span class="co">## [1] IAGOS</span></span></code></pre>
<p><embed src="paper_files/figure-latex/unnamed-chunk-6-1.pdf"></embed><!-- --> Finally, we show some vertical profiles for the months of January and March of 2020. We can see how during March of 2020 methane concentrations are lower than January. This may be due the implementation of Lockdowns [@espinosa2023covid]. A manuscript focused on the impact of COVID-19 on methane emissions will be submitted soon.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">df3</span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">ch4</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">value</span><span class="op">*</span><span class="fl">1e+9</span></span>
<span><span class="fu"><a href="reference/obs_plot.html">obs_plot</a></span><span class="op">(</span><span class="va">x</span>, </span>
<span>         time <span class="op">=</span> <span class="st">"ch4"</span>, </span>
<span>         y <span class="op">=</span> <span class="st">"altitude_final"</span>, </span>
<span>         colu <span class="op">=</span> <span class="st">"month"</span>, </span>
<span>         type <span class="op">=</span> <span class="st">"b"</span>, </span>
<span>         xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">CH</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">~</span><span class="va">ppb</span><span class="op">)</span>, </span>
<span>         ylab <span class="op">=</span> <span class="st">"altitude (m)"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Found the following sites:</span></span>
<span><span class="co">## [1] 1 3</span></span>
<span><span class="co">## Plotting the following sites:</span></span>
<span><span class="co">## [1] 1 3</span></span></code></pre>
<p><embed src="paper_files/figure-latex/unnamed-chunk-7-1.pdf"></embed><!-- --></p>
</div>
<div class="section level2">
<h2 id="future-work">Future work<a class="anchor" aria-label="anchor" href="#future-work"></a></h2>
<p>We are currently porting <code>rtorf</code> to python into a package named <code>pytorf</code> with the same functionalities. Furthermore, we expect to implement WebAsembly with Web-R<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;&lt;a href="https://docs.r-wasm.org/webr/latest/" class="external-link uri"&gt;https://docs.r-wasm.org/webr/latest/&lt;/a&gt;&lt;/p&gt;'><sup>3</sup></a> in R and Python to run <code>rtorf</code> on the browser [@webr].</p>
</div>
</div>
<div class="section level1">
<h1 id="acknowledgements">Acknowledgements<a class="anchor" aria-label="anchor" href="#acknowledgements"></a></h1>
<p>This project is funded by the NOAA Climate Program Office AC4 and COM programs (NA21OAR4310233 / NA21OAR4310234). This research was supported by NOAA cooperative agreement NA22OAR4320151. Also, thanks to Arlyn Andrews, John Miller, Kenneth Schuldt, Kirk Thoning and Andy Jacobson from NOAA GML.</p>
</div>
<div class="section level1">
<h1 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h1>
</div>



  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sergio Ibarra-Espinosa.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

